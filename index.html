<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HelpDesk Mini</title>
  <style>
    body{font-family:Segoe UI,Arial,Helvetica,sans-serif;margin:24px}
    #nav a{margin-right:12px}
    #root h2{margin-top:0}
    input, textarea{width:100%;padding:8px;margin:6px 0}
    button{padding:8px 12px}
  </style>
</head>
<body>
  <nav id="nav"><a href="/">Home</a></nav>
  <div id="root">Open frontend</div>

  <!-- Optional: set window.__API_BASE__ before the app script when deploying to Vercel
       <script>window.__API_BASE__ = 'https://your-api.example.com/api'</script>
  -->

  <script>
  // Single-file frontend (inlined) â€” configurable API base
  const API_BASE = (window.__API_BASE__ || '/api');
  const DEMO_MODE = (typeof window.__API_BASE__ === 'undefined');

  // apiFetch: real fetch when API_BASE provided, otherwise use an in-memory demo backend
  function apiFetch(path, opts={}){
    opts = opts || {};
    opts.headers = opts.headers || {};
    const token = localStorage.getItem('token');
    if(token && !DEMO_MODE) opts.headers['Authorization'] = 'Token '+token;

    if(DEMO_MODE){
      // Simple in-memory demo backend
      // State is stored on window so it survives soft reloads
      window.__demo = window.__demo || { users: [{username:'admin', password:'admin123', token:'demo-admin-token'}], tickets: [], comments: {} };
      const demo = window.__demo;

      // helper to parse path
      const url = new URL('http://demo'+path);
      const parts = url.pathname.split('/').filter(Boolean);

      // POST /auth/login
      if(path.startsWith('/auth/login') && opts.method === 'POST'){
        const body = JSON.parse(opts.body || '{}');
        const u = demo.users.find(x=>x.username===body.username && x.password===body.password);
        if(u) return Promise.resolve({ok:true, status:200, body:{token:u.token, username:u.username}});
        return Promise.resolve({ok:false, status:401, body:{error:'invalid'}});
      }

      // GET /tickets
      if(path.startsWith('/tickets') && (!opts.method || opts.method==='GET')){
        const items = demo.tickets.slice().reverse();
        return Promise.resolve({ok:true, status:200, body:{items, next_offset:null}});
      }

      // POST /tickets
      if(path=== '/tickets' && opts.method==='POST'){
        const body = JSON.parse(opts.body||'{}');
        const id = crypto.randomUUID();
        const now = new Date();
        const sla_minutes = body.sla_minutes||60;
        const sla_deadline = new Date(now.getTime() + sla_minutes*60000).toISOString();
        const author = token ? token.replace('demo-','') : 'demo';
        const ticket = { id, title: body.title||'Untitled', description: body.description||'', status:'open', sla_minutes, sla_deadline, author:{username:author}, comments:[] };
        demo.tickets.push(ticket);
        return Promise.resolve({ok:true, status:201, body: ticket});
      }

      // GET /tickets/:id
      if(parts[0]==='tickets' && parts.length===2 && (!opts.method || opts.method==='GET')){
        const id = parts[1];
        const t = demo.tickets.find(x=>x.id===id);
        if(!t) return Promise.resolve({ok:false, status:404, body:{error:'not found'}});
        // attach comments
        t.comments = demo.comments[id]||[];
        return Promise.resolve({ok:true, status:200, body:t});
      }

      // POST /tickets/:id/comments
      if(parts[0]==='tickets' && parts.length===3 && parts[2]==='comments' && opts.method==='POST'){
        const id = parts[1];
        const body = JSON.parse(opts.body||'{}');
        const comment = { id: crypto.randomUUID(), body: body.body||'', author: { username: token ? token.replace('demo-','') : 'demo' }, created_at: new Date().toISOString() };
        demo.comments[id] = demo.comments[id]||[];
        demo.comments[id].push(comment);
        return Promise.resolve({ok:true, status:201, body:comment});
      }

      // Fallback demo: health
      if(path.startsWith('/health')) return Promise.resolve({ok:true, status:200, body:{status:'ok'}});

      return Promise.resolve({ok:false, status:404, body:{error:'not implemented in demo'}});
    }

    // Real backend
    return fetch(API_BASE + path, opts).then(r => r.json().then(b => ({ok:r.ok, status:r.status, body:b}))).catch(e=>({ok:false,status:0,body:{error:String(e)}}));
  }

  function navigate(path){
    history.pushState({},'',path);
    render();
  }

  function el(tag, attrs={}, ...children){
    const e = document.createElement(tag);
    Object.entries(attrs).forEach(([k,v])=>{ if(k.startsWith('on')) e.addEventListener(k.slice(2), v); else e.setAttribute(k,v); });
    children.forEach(c=>{ if(typeof c==='string') e.appendChild(document.createTextNode(c)); else if(c) e.appendChild(c); });
    return e;
  }

  async function pageTickets(){
    const container = el('div');
    const q = new URLSearchParams(location.search).get('q')||'';
    const res = await apiFetch('/tickets?limit=20&offset=0&q='+encodeURIComponent(q));
    if(!res.ok){ container.appendChild(el('pre',{}, JSON.stringify(res.body))); return container; }
    const list = el('ul');
    res.body.items.forEach(t=>{
      const a = el('a',{href:'/tickets/'+t.id, onclick: (e)=>{ e.preventDefault(); navigate('/tickets/'+t.id); }}, t.title+' ('+t.status+')');
      list.appendChild(el('li',{}, a));
    });
    container.appendChild(el('h2',{}, 'Tickets'));
    container.appendChild(el('button',{onclick:()=>navigate('/tickets/new')}, 'New Ticket'));
    container.appendChild(el('div',{}, el('input',{id:'q', value:q}), el('button',{onclick:()=>{ navigate('/tickets?q='+document.getElementById('q').value);} }, 'Search')));
    container.appendChild(list);
    return container;
  }

  async function pageNew(){
    const form = el('form',{},
      el('h2',{}, 'New Ticket'),
      el('div',{}, 'Title:', el('input',{id:'title'})),
      el('div',{}, 'Description:', el('textarea',{id:'desc'})),
      el('div',{}, 'SLA minutes:', el('input',{id:'sla', value:60})),
      el('button',{type:'submit'}, 'Create')
    );
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const body = JSON.stringify({ title: document.getElementById('title').value, description: document.getElementById('desc').value, sla_minutes: parseInt(document.getElementById('sla').value||60)});
      const idk = crypto.randomUUID();
      const res = await fetch(API_BASE + '/tickets',{method:'POST', headers:{'Content-Type':'application/json','Idempotency-Key': idk, 'Authorization': 'Token '+localStorage.getItem('token')}, body});
      const data = await res.json();
      if(res.ok) navigate('/tickets/'+data.id);
      else alert(JSON.stringify(data));
    });
    return form;
  }

  async function pageTicket(id){
    const res = await apiFetch('/tickets/'+id);
    const c = el('div');
    if(!res.ok){ c.appendChild(el('pre',{}, JSON.stringify(res.body))); return c; }
    const t = res.body;
    c.appendChild(el('h2',{}, t.title));
    c.appendChild(el('div',{}, 'Status: '+t.status));
    c.appendChild(el('div',{}, 'Description:', el('p',{}, t.description)));
    c.appendChild(el('div',{}, 'SLA deadline: '+t.sla_deadline));
    const commentsSection = el('div',{}, el('h3',{}, 'Comments'));
    (t.comments||[]).forEach(cm=>{ commentsSection.appendChild(el('div',{}, cm.author.username+': '+cm.body)); });
    const cform = el('form',{}, el('textarea',{id:'cbody'}), el('button',{type:'submit'}, 'Comment'));
    cform.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const body = JSON.stringify({ body: document.getElementById('cbody').value });
      const idk = crypto.randomUUID();
      const resp = await fetch(API_BASE + '/tickets/'+id+'/comments',{method:'POST', headers:{'Content-Type':'application/json','Idempotency-Key':idk, 'Authorization':'Token '+localStorage.getItem('token')}, body});
      const jb = await resp.json();
      if(resp.ok) location.reload(); else alert(JSON.stringify(jb));
    });
    c.appendChild(commentsSection);
    c.appendChild(cform);
    return c;
  }

  async function pageLogin(){
    const f = el('form',{}, el('h2',{}, 'Login'), el('div',{}, 'Username:', el('input',{id:'luser'})), el('div',{}, 'Password:', el('input',{id:'lpass', type:'password'})), el('button',{type:'submit'}, 'Login'));
    f.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const b = JSON.stringify({username:document.getElementById('luser').value, password:document.getElementById('lpass').value});
      const r = await fetch(API_BASE + '/auth/login',{method:'POST', headers:{'Content-Type':'application/json'}, body:b});
      const jb = await r.json();
      if(r.ok){ localStorage.setItem('token', jb.token); navigate('/tickets'); }
      else alert(JSON.stringify(jb));
    });
    return f;
  }

  async function render(){
    const root = document.getElementById('root');
    root.innerHTML = '';
    const path = location.pathname;
    if(path==='/' || path.startsWith('/tickets') && path.split('/').length===2 && path.endsWith('s')){
      root.appendChild(await pageTickets());
    } else if(path==='/tickets/new'){
      root.appendChild(await pageNew());
    } else if(path.startsWith('/tickets/') && path.split('/').length===3){
      const id = path.split('/')[2];
      root.appendChild(await pageTicket(id));
    } else if(path==='/login'){
      root.appendChild(await pageLogin());
    } else {
      root.appendChild(el('div',{}, 'Not Found'));
    }
  }

  window.addEventListener('popstate', render);
  window.addEventListener('load', ()=>{
    const nav = document.getElementById('nav');
    if(nav){ nav.appendChild(el('a',{href:'/tickets', onclick:(e)=>{e.preventDefault(); navigate('/tickets');}}, 'Tickets')); nav.appendChild(el('a',{href:'/login', onclick:(e)=>{e.preventDefault(); navigate('/login');}}, 'Login'))}
    render();
  });
  </script>

</body>
</html>